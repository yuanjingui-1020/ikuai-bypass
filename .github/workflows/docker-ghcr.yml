name: ğŸ³ Build and Publish to GHCR

# å®šä¹‰è§¦å‘äº‹ä»¶ï¼šåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
on:
  push:
    branches: [ "main" ]
  # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼šå¿…é¡»è¦æœ‰ packages: write æƒé™æ‰èƒ½æ¨é€åˆ° GHCR
permissions:
  contents: read
  packages: write
  # å¦‚æœéœ€è¦è¯»/å†™ Issues, PRs ç­‰ï¼Œä¹Ÿè¦åœ¨æ­¤å¤„æ·»åŠ ç›¸åº”çš„æƒé™

# å®šä¹‰æ„å»ºä»»åŠ¡
jobs:
  build_and_push_image:
    runs-on: ubuntu-latest
    
    # ç¯å¢ƒå˜é‡ï¼šå®šä¹‰æ³¨å†Œè¡¨å’Œä»“åº“åï¼Œä¾¿äºç®¡ç†
    env:
      REGISTRY: ghcr.io
      # ä½¿ç”¨ GitHub çš„ä»“åº“è·¯å¾„ä½œä¸ºé•œåƒå
      IMAGE_NAME: ${{ github.repository }}

    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Set up Docker Buildx
      # å¯ç”¨ BuildKit å’Œå¤šå¹³å°æ„å»ºæ”¯æŒ
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Login to GHCR
      # ä½¿ç”¨ GitHub Token ç™»å½•åˆ° GitHub Container Registry (GHCR)
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }} # ä½¿ç”¨è§¦å‘ action çš„ç”¨æˆ·æˆ–æœºå™¨äºº
        password: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKEN

    - name: ğŸ·ï¸ Extract Docker metadata (Tags and Labels)
      # è‡ªåŠ¨ç”ŸæˆåŸºäº Git ä¿¡æ¯çš„æ ‡ç­¾ (å¦‚ latest, commit SHA)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,format=short

    - name: ğŸ”¨ Build and Push Docker image
      # æ„å»ºé•œåƒå¹¶æ¨é€åˆ° GHCR
      uses: docker/build-push-action@v6
      with:
        context: . # Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„
        file: ./Dockerfile # Dockerfile è·¯å¾„
        push: true # è®¾ä¸º true æ‰ä¼šæ¨é€åˆ° GHCR
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
